extends ../layout

block content
  .d-flex.justify-content-between.align-items-center.mb-4
    h2.text-primary 
      i.bi.bi-people.me-2
      | Klanten Beheer
    .d-flex.justify-content-between.align-items-center
      .btn-group
        button.btn.btn-success(type="button" data-bs-toggle="modal" data-bs-target="#createCustomerModal")
          i.bi.bi-plus-circle.me-1
      .input-group(style="max-width: 300px")
        input.form-control(type="text" id="customer_search" placeholder="Zoek klanten...")
        button.btn.btn-primary(type="button" onclick="searchCustomers()")
          i.bi.bi-search
  
  #search_results.mb-3

  if customers && customers.length
    .card
      .card-header.bg-primary.text-white
        h5.mb-0 Alle Klanten (#{customers.length})
      .card-body.p-0
        .table-responsive
          table.table.table-striped.table-hover.mb-0
            thead.table-dark
              tr
                th ID
                th Naam
                th Email
                th Adres
                th Status
                th Totaal Verhuur
                th Laatste Verhuur
                th Acties
            tbody
              each customer in customers
                tr
                  td #{customer.customer_id}
                  td
                    strong #{customer.full_name}
                  td #{customer.email}
                  td
                    if customer.address
                      | #{customer.address}
                      br
                      small.text-muted #{customer.city}, #{customer.country}
                    else
                      span.text-muted Geen adres
                  td
                    if customer.active
                      span.badge.bg-success Actief
                    else
                      span.badge.bg-danger Inactief
                  td
                    span.badge.bg-info #{customer.total_rentals || 0}
                  td
                    if customer.last_rental
                      | #{new Date(customer.last_rental).toLocaleDateString('nl-NL')}
                    else
                      span.text-muted Nog nooit
                  td
                    .btn-group(role="group")
                      a.btn.btn-sm.btn-info(href="javascript:void(0)" onclick=`showCustomerDetails(${customer.customer_id})`)
                        i.bi.bi-eye.me-1
                      a.btn.btn-sm.btn-warning(href=`/staff/customer/${customer.customer_id}/edit`)
                        i.bi.bi-pencil.me-1
  else
    .alert.alert-info.text-center
      h4 
        i.bi.bi-info-circle.me-2
        | Geen klanten gevonden
      p Er zijn geen klanten beschikbaar in het systeem.
  
  #customerDetailsModal.modal.fade(tabindex="-1")
    .modal-dialog.modal-lg
      .modal-content
        .modal-header
          h5.modal-title Klant Details
          button.btn-close(type="button" data-bs-dismiss="modal")
        .modal-body
          div#customerDetailsContent
            .text-center.text-muted
              i.bi.bi-hourglass-split.me-2
              | Laden...
        .modal-footer
          button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Sluiten

  #createCustomerModal.modal.fade(tabindex="-1")
    .modal-dialog
      .modal-content
        .modal-header
          h5.modal-title Nieuwe Klant
          button.btn-close(type="button" data-bs-dismiss="modal")
        form(method="POST" action="/staff/customers/create")
          .modal-body
            .mb-3
              label.form-label Voornaam
              input.form-control(type="text" name="first_name" required)
            .mb-3
              label.form-label Achternaam
              input.form-control(type="text" name="last_name" required)
            .mb-3
              label.form-label Email
              input.form-control(type="email" name="email" required)
            .mb-3
              label.form-label Wachtwoord
              input.form-control(type="password" name="password" required)
            .mb-3
              label.form-label Adres
              input.form-control(type="text" name="address" requeired)
            .mb-3
              label.form-label Stad
              input.form-control(type="text" name="city" required)
            .mb-3
              label.form-label Land
              input.form-control(type="text" name="country" required)
          .modal-footer
            button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Annuleren
            button.btn.btn-primary(type="submit") Opslaan

  script.
    let currentCustomerId = null;
    function showCustomerDetails(customerId) {
        fetch(`/staff/customer/${customerId}`)
          .then(res => res.json())
          .then(customer => {
            const html = `
              <p><strong>ID:</strong> ${customer.customer_id}</p>
              <p><strong>Naam:</strong> ${customer.first_name} ${customer.last_name}</p>
              <p><strong>Email:</strong> ${customer.email}</p>
              <p><strong>Adres:</strong> ${customer.address || '-'}, ${customer.city || ''}, ${customer.country || ''}</p>
              <p><strong>Status:</strong> ${customer.active ? 'Actief' : 'Inactief'}</p>
              <p><strong>Totaal Verhuur:</strong> ${customer.total_rentals || 0}</p>
              <p><strong>Laatst Verhuur:</strong> ${customer.last_rental_date ? new Date(customer.last_rental_date).toLocaleDateString('nl-NL') : 'Nog nooit'}</p>
              <div class="mt-3">
                <a href="/staff/customer/${customer.customer_id}/edit" class="btn btn-warning btn-sm">
                  <i class="bi bi-pencil me-1"></i> Bewerken
                </a>
              </div>
            `;
            document.getElementById('customerDetailsContent').innerHTML = html;

            const modalEl = document.getElementById('customerDetailsModal');
            const modal = new bootstrap.Modal(modalEl);
            modalEl.addEventListener('shown.bs.modal', () => {
              modalEl.querySelector('[tabindex], button, input, a')?.focus();
            });
            modal.show();
          })
          .catch(err => {
            document.getElementById('customerDetailsContent').innerHTML =
              '<div class="alert alert-danger">Kon klantgegevens niet laden.</div>';
            console.error(err);
          });
      }

    function searchCustomers() {
      const query = document.getElementById('customer_search').value;
      if (query.length < 2) {
        document.getElementById('search_results').innerHTML = '';
        return;
      }
      
      fetch(`/staff/customers/search?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
          if (data.customers) {
            displaySearchResults(data.customers);
          }
        })
        .catch(error => console.error('Error:', error));
    }

    function displaySearchResults(customers) {
      const resultsDiv = document.getElementById('search_results');
      if (customers.length === 0) {
        resultsDiv.innerHTML = '<div class="alert alert-warning">Geen klanten gevonden</div>';
        return;
      }
      
      let html = '<div class="card"><div class="card-header bg-success text-white"><h6 class="mb-0">Zoekresultaten</h6></div><div class="list-group list-group-flush">';
      customers.forEach(customer => {
        html += `
          <div class="list-group-item d-flex justify-content-between align-items-center">
            <div>
              <strong>${customer.full_name}</strong><br>
              <small class="text-muted">${customer.email} - ID: ${customer.customer_id}</small>
            </div>
            <div class="btn-group">
              <button 
                class="btn btn-sm btn-info" 
                onclick="showCustomerDetails(${customer.customer_id})">
                <i class="bi bi-eye me-1"></i> Details
              </button>
              <a href="/staff/customer/${customer.customer_id}/edit" class="btn btn-sm btn-warning">
                <i class="bi bi-pencil me-1"></i> Bewerken
              </a>
            </div>
          </div>
        `;
      });
      html += '</div></div>';
      resultsDiv.innerHTML = html;
    }

    function startRental(customerId, customerName) {
      currentCustomerId = customerId;
      document.getElementById('modal_customer_name').textContent = customerName;
      new bootstrap.Modal(document.getElementById('quickRentalModal')).show();
    }

    // Enable enter key for search
    document.getElementById('customer_search').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        e.preventDefault();
        searchCustomers();
      }
    });